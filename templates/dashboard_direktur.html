<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Direktur</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dvul7dq3b/image/upload/v1755843240/logowebp_bqssky.webp" />
    <!-- CSS Lengkap Disalin dari dashboard_kajur.html -->
    <style>
        /* Reset dasar */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            background: url("https://res.cloudinary.com/dvul7dq3b/image/upload/v1757145957/bg_vgrbsv.webp") repeat-y center top / cover;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 30px 10px;
            color: #fff;
        }

        .overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 0;
        }
        .container {
            position: relative; z-index: 1;
            max-width: 1000px; width: 100%;
            background: rgba(10, 25, 47, 0.85);
            backdrop-filter: blur(6px);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            animation: fadeIn 0.8s ease-in-out;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 26px; font-weight: bold; }
        .header a, .btn {
            text-decoration: none;
            color: #fff;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            transition: transform 0.2s, background 0.3s;
            border: none;
            cursor: pointer;
        }
        .header a:hover, .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, #0d6efd, #0a58ca); }
        .btn-info { background: linear-gradient(135deg, #0dcaf0, #0a95b0); }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #a71d2a); }
        .btn-success { background: linear-gradient(135deg, #198754, #0f5132); }
        .info-box {
            background: rgba(255,255,255,0.05);
            border-left: 5px solid #0d6efd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        h2 {
            margin: 25px 0 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 6px;
            font-size: 20px;
        }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid rgba(255,255,255,0.2); padding: 12px; text-align: left; }
        th { background: rgba(255,255,255,0.1); }
        tr:nth-child(even) { background: rgba(255,255,255,0.05); }
        
        /* Status warna dari kajur.html (PENTING) */
        .status-red { background-color: rgba(220,53,69,0.2); color: #ff6b6b; }
        .status-green { background-color: rgba(25,135,84,0.2); color: #00ffb3; }
        .status-yellow { background-color: rgba(255,193,7,0.2); color: #ffdd57; }
        
        /* Modal dari kajur.html (PENTING) */
        .modal-backdrop {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: rgba(10,25,47,0.95); padding: 20px; border-radius: 12px;
            width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto;
            animation: fadeIn 0.5s;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;
        }
        .close-btn { cursor: pointer; border: none; background: none; font-size: 24px; color: #fff; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* CSS untuk Ikon Aksi (Preview & Download) */
.action-icons {
    display: flex;
    gap: 10px; /* Jarak antar ikon */
    align-items: center;
}
.btn-icon {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 36px;
    height: 36px;
    background: rgba(255, 255, 255, 0.1);
    color: #66b2ff;
    border-radius: 8px;
    text-decoration: none;
    transition: background 0.3s, color 0.3s;
}
.btn-icon:hover {
    background: rgba(102, 178, 255, 0.2);
    color: #fff;
}
    </style>
</head>
<body>
    <div class="overlay"></div>
    <div class="container">
        <div class="header">
            <!-- Perubahan 1: Judul Disesuaikan -->
            <h1>Dashboard Direktur</h1>
            <div>
                <a href="{{ url_for('dashboard_dosen') }}" class="btn btn-primary" style="margin-right: 10px;">Absensi Pribadi Saya</a>
                <a href="{{ url_for('history') }}" class="btn btn-info" style="margin-right: 10px;">Riwayat Persetujuan</a>
                <a href="/logout" class="btn btn-danger">Logout</a>
            </div>
        </div>
        <button id="btn-enable-push">Aktifkan Notifikasi</button>
        <script src="{{ url_for('static', filename='js/main.js') }}"></script>
        <div class="info-box">
            <p><strong>Nama:</strong> {{ session['user_name'] }}</p>
            <!-- Perubahan 2: Teks Disesuaikan -->
            <p><strong>Unit Kerja:</strong> {{ session['user_jurusan'] }}</p>
        </div>

        <h2>Daftar Pengajuan Klarifikasi</h2>
        <table>
            <thead>
                <tr>
                    <th>Tgl Pengajuan</th>
                    <!-- Perubahan 3: Teks Disesuaikan -->
                    <th>Nama Pengaju</th>
                    <th>Tgl Klarifikasi</th>
                    <th>Jenis Surat</th>
                    <th>File Bukti</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for klarifikasi in records %}
                <tr>
                    <td>{{ klarifikasi.tanggal_pengajuan.split(' ')[0] }}</td>
                    <td>{{ klarifikasi.nama_lengkap }}</td>
                    <td>{{ klarifikasi.tanggal_klarifikasi.split(' ')[0] }}</td>
                    <td>{{ klarifikasi.jenis_surat }}</td>
                    <td class="action-icons">
    {% if klarifikasi.file_bukti %}
        <!-- Ikon Mata untuk PREVIEW (membuka tab baru) -->
        <a href="{{ url_for('preview_bukti', clarification_id=klarifikasi.id) }}" target="_blank" class="btn-icon" title="Lihat Bukti di Tab Baru">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
        </a>
        <!-- Ikon Unduh untuk DOWNLOAD (langsung mengunduh) -->
        <a href="{{ url_for('download_bukti', clarification_id=klarifikasi.id) }}" class="btn-icon" title="Download Bukti">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        </a>
    {% else %} 
        - 
    {% endif %}
</td>
                    <td>
                        <form style="display:inline;" action="/proses_klarifikasi" method="post">
                            <input type="hidden" name="clarification_id" value="{{ klarifikasi.id }}">
                            <button type="submit" name="action" value="setuju" class="btn btn-success">Setujui</button>
                        </form>
                        <form style="display:inline;" action="/proses_klarifikasi" method="post" onsubmit="return handleTolak(this);">
                            <input type="hidden" name="clarification_id" value="{{ klarifikasi.id }}">
                            <input type="hidden" name="alasan_penolakan" value="">
                            <button type="submit" name="action" value="tolak" class="btn btn-danger">Tolak</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" style="text-align: center;">Tidak ada pengajuan klarifikasi.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Perubahan 4: Judul Disesuaikan -->
        <h2>Daftar Pimpinan & Staf Langsung Anda</h2>
        <table>
            <thead>
                <tr><th>NIP</th><th>Nama Lengkap</th><th>Aksi</th></tr>
            </thead>
            <tbody>
                <!-- Perubahan 5: Variabel Loop Disesuaikan -->
                {% for bawahan in bawahan_list %}
                <tr>
                    <td>{{ bawahan.nip }}</td>
                    <td>{{ bawahan.nama_lengkap }}</td>
                    <td><button class="btn btn-info" onclick="showAbsensi('{{ bawahan.nip }}')">Cek Absensi</button></td>
                </tr>
                {% else %}
                <tr><td colspan="3" style="text-align: center;">Tidak ada data pimpinan/staf yang melapor langsung.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- STRUKTUR MODAL DAN JAVASCRIPT LENGKAP DISALIN DARI dashboard_kajur.html -->
    <div class="modal-backdrop" id="absensiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Riwayat Absensi</h3>
                <button class="close-btn" onclick="hideAbsensi()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Ganti seluruh blok <script> Anda dengan ini -->
<script>
    function handleTolak(form) {
        const alasan = prompt("Silakan masukkan alasan penolakan:");
        if (alasan) { form.alasan_penolakan.value = alasan; return true; }
        return false;
    }

    const modal = document.getElementById('absensiModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    async function showAbsensi(nip) {
        modal.style.display = 'flex';
        modalTitle.textContent = "Memuat data...";
        modalBody.innerHTML = '<p style="text-align:center;">Mengambil data dari server...</p>';

        try {
            const response = await fetch(`/get_absensi_summary/${nip}`);
            if (!response.ok) throw new Error('Network response was not ok.');
            const data = await response.json();
            
            modalTitle.textContent = `Riwayat Absensi: ${data.nama_lengkap}`;
            
            // --- INILAH "PINTU" BARUNYA ---
            // 1. Kita buat URL untuk halaman riwayat cuti bawahan
            const leaveHistoryUrl = `/riwayat_cuti_bawahan/${nip}`;
            
            // 2. Kita masukkan link ini ke dalam HTML pop-up
            let contentHTML = `
                <div class="cuti-summary" style="display: flex; justify-content: space-around; text-align: center; margin-bottom: 20px; padding: 10px; background-color: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div>
                        <p style="margin: 0; font-size: 12px; color: #adb5bd;">Jatah Cuti Tahunan</p>
                        <p style="margin: 0; font-size: 18px; font-weight: bold;">${data.jatah_cuti} Hari</p>
                    </div>
                    <div>
                        <p style="margin: 0; font-size: 12px; color: #adb5bd;">Cuti Terpakai</p>
                        <p style="margin: 0; font-size: 18px; font-weight: bold;">${data.cuti_terpakai} Hari</p>
                    </div>
                    <div>
                        <p style="margin: 0; font-size: 12px; color: #adb5bd;">Sisa Cuti</p>
                        <p style="margin: 0; font-size: 18px; font-weight: bold; color: #00ffb3;">${data.sisa_cuti} Hari</p>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 20px;">
                    <a href="${leaveHistoryUrl}" target="_blank" style="color: #66b2ff; text-decoration: underline; font-weight: 500; font-size: 14px;">
                        Lihat Riwayat Cuti (Input Admin) di Tab Baru
                    </a>
                </div>
                
                <h4>Rekap Absensi Bulan Terakhir</h4>
                <table style="width: 100%;">
                    <thead><tr><th>Tanggal</th><th>Jam Masuk</th><th>Jam Pulang</th><th>Status</th></tr></thead>
                    <tbody>
            `;

            if (data.records && data.records.length > 0) {
                data.records.forEach(rec => {
                    contentHTML += `
                        <tr>
                            <td>${rec.tanggal_formatted}</td>
                            <td>${rec.jam_masuk_formatted}</td>
                            <td>${rec.jam_pulang_formatted}</td>
                            <td class="${rec.status_color}">${rec.status_text}</td>
                        </tr>`;
                });
            } else {
                contentHTML += `<tr><td colspan="4" style="text-align:center;">Tidak ada data absensi untuk bulan ini.</td></tr>`;
            }
            contentHTML += `</tbody></table>`;

            modalBody.innerHTML = contentHTML;

        } catch (error) {
            console.error('Error fetching data:', error);
            modalTitle.textContent = 'Gagal Memuat Data';
            modalBody.innerHTML = '<p style="text-align:center; color: #ff6b6b;">Terjadi kesalahan saat mengambil data.</p>';
        }
    }

    function hideAbsensi() {
        modal.style.display = 'none';
    }
</script>
</body>
</html>

